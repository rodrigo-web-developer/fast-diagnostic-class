<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard · Fast Diagnostic Class</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="change-theme-top-right">
        <button id="themeToggle" class="icon-btn" title="Toggle Theme" type="button">
            <!-- Sun Icon (for Light Mode) -->
            <svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                style="display:none; color: var(--text-bright);">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
            <!-- Moon Icon (for Dark Mode) -->
            <svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--text-bright);">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
        </button>
    </div>
    <div class="container">
        <section class="hero">
            <a class="badge" href="/">← Back to home</a>
            <h1>Live Dashboard</h1>
            <p>Review submissions, score distributions, and tag-level performance for every questionnaire.</p>
        </section>

        <section class="card">
            <h2 class="section-title">Select Questionnaire</h2>
            <div class="form-group">
                <label for="formSelector">Questionnaire</label>
                <select id="formSelector"></select>
            </div>
        </section>

        <section class="card">
            <h2 class="section-title">Key Metrics</h2>
            <div class="form-grid" id="metricsGrid"></div>
        </section>

        <section class="card">
            <h2 class="section-title">Tag Performance - Correct Count</h2>
            <div class="chart-panel">
                <canvas id="tagCountChart"></canvas>
            </div>
        </section>

        <section class="card">
            <h2 class="section-title">Tag Performance - Score (Weight-based)</h2>
            <div class="chart-panel">
                <canvas id="tagScoreChart"></canvas>
            </div>
        </section>

        <section class="card">
            <h2 class="section-title">Score Distribution</h2>
            <div class="chart-panel">
                <canvas id="scoreChart"></canvas>
            </div>
        </section>

        <section class="card">
            <h2 class="section-title">Response History</h2>
            <div style="overflow-x: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Score</th>
                            <th>Correct</th>
                            <th>Submitted</th>
                        </tr>
                    </thead>
                    <tbody id="responsesTable"></tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        let allForms = [];
        let dashboardStats = null;
        let scoreChart = null;
        let tagScoreChart = null;
        let tagCountChart = null;

        function renderMetrics(stats) {
            const metricsGrid = document.getElementById('metricsGrid');
            if (stats.totalStudents === 0) {
                metricsGrid.innerHTML = '<p class="muted">No responses yet.</p>';
                return;
            }

            const scores = stats.results.map(r => r.scorePercentage);
            const average = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
            const highest = Math.max(...scores).toFixed(1);
            const lowest = Math.min(...scores).toFixed(1);
            const last = stats.results[0]?.submittedAt 
                ? new Date(stats.results[0].submittedAt).toLocaleString() 
                : 'N/A';

            metricsGrid.innerHTML = `
                <div class="card">
                    <div class="muted">Total Responses</div>
                    <h2>${stats.totalStudents}</h2>
                </div>
                <div class="card">
                    <div class="muted">Average Score</div>
                    <h2>${average}%</h2>
                </div>
                <div class="card">
                    <div class="muted">Highest Score</div>
                    <h2>${highest}%</h2>
                </div>
                <div class="card">
                    <div class="muted">Lowest Score</div>
                    <h2>${lowest}%</h2>
                </div>
                <div class="card">
                    <div class="muted">Last Submission</div>
                    <h2 style="font-size: 1.2rem;">${last}</h2>
                </div>
            `;
        }

        function renderScoreChart(stats) {
            const ctx = document.getElementById('scoreChart').getContext('2d');
            const labels = stats.results.map(r => r.name);
            const data = stats.results.map(r => r.scorePercentage);

            if (scoreChart) scoreChart.destroy();
            scoreChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Score %',
                        data,
                        backgroundColor: 'rgba(63, 185, 177, 0.6)',
                        borderColor: 'rgba(31, 138, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function renderTagCountChart(tagStats) {
            const ctx = document.getElementById('tagCountChart').getContext('2d');
            const labels = Object.keys(tagStats);
            const data = labels.map(tag => tagStats[tag].avgCorrectCount);
            const maxCount = Math.max(...labels.map(tag => tagStats[tag].totalQuestions));

            if (tagCountChart) tagCountChart.destroy();
            tagCountChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Avg Correct Count',
                        data,
                        backgroundColor: 'rgba(99, 110, 250, 0.6)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: maxCount
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const tag = context.label;
                                    return `Total questions: ${tagStats[tag].totalQuestions}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderTagScoreChart(tagStats) {
            const ctx = document.getElementById('tagScoreChart').getContext('2d');
            const labels = Object.keys(tagStats);
            const data = labels.map(tag => tagStats[tag].scorePercentage);

            if (tagScoreChart) tagScoreChart.destroy();
            tagScoreChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Score %',
                        data,
                        backgroundColor: 'rgba(255, 176, 133, 0.7)',
                        borderColor: 'rgba(239, 114, 70, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const tag = context.label;
                                    return `Total weight: ${tagStats[tag].totalWeight}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderResponsesTable(stats) {
            const tbody = document.getElementById('responsesTable');
            if (stats.totalStudents === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="muted">No responses submitted yet.</td></tr>';
                return;
            }
            
            // Sort by submission time (most recent first)
            const sortedResults = [...stats.results].sort((a, b) => 
                new Date(b.submittedAt) - new Date(a.submittedAt)
            );

            tbody.innerHTML = sortedResults.map(result => `
                <tr>
                    <td>${result.name}</td>
                    <td>${result.scorePercentage.toFixed(1)}%</td>
                    <td>${result.correctCount}/${stats.totalQuestions}</td>
                    <td>${new Date(result.submittedAt).toLocaleString()}</td>
                </tr>
            `).join('');
        }

        async function updateDashboard(formId) {
            try {
                const response = await fetch(`/api/dashboard?formId=${formId}`);
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    console.error('Failed to load dashboard:', result.message);
                    return;
                }

                dashboardStats = result.data;
                
                renderMetrics(dashboardStats);
                renderScoreChart(dashboardStats);
                renderTagCountChart(dashboardStats.tagStats);
                renderTagScoreChart(dashboardStats.tagStats);
                renderResponsesTable(dashboardStats);
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }

        async function loadForms() {
            try {
                const response = await fetch('/api/forms');
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    console.error('Failed to load forms');
                    return;
                }

                allForms = result.data;
                const selector = document.getElementById('formSelector');
                
                if (allForms.length === 0) {
                    selector.innerHTML = '<option>No questionnaires yet</option>';
                    document.getElementById('metricsGrid').innerHTML = '<p class="muted">Create a questionnaire first.</p>';
                    return;
                }

                selector.innerHTML = allForms.map(form => `
                    <option value="${form.id}" ${form.active ? 'selected' : ''}>
                        ${form.title} ${form.active ? '(Active)' : ''}
                    </option>
                `).join('');

                // Load dashboard for the selected form
                const selectedFormId = selector.value;
                if (selectedFormId) {
                    updateDashboard(selectedFormId);
                }
            } catch (error) {
                console.error('Error loading forms:', error);
            }
        }

        document.getElementById('formSelector').addEventListener('change', event => {
            updateDashboard(event.target.value);
        });

        // Auto-refresh every 5 seconds
        setInterval(() => {
            const selector = document.getElementById('formSelector');
            if (selector.value) {
                updateDashboard(selector.value);
            }
        }, 5000);

        loadForms();
    </script>
    <script src="/scripts.js"></script>
</body>
</html>
